<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#005EB8">
    <title>Midwife Companion</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* === NHS STYLE THEME === */
        :root {
            --nhs-blue: #005EB8;
            --nhs-dark-blue: #003087;
            --nhs-green: #009639;
            --nhs-warm-yellow: #FFB81C;
            --nhs-red: #D5281B;
            --nhs-grey-1: #4C6272;
            --nhs-grey-5: #F0F4F5;
            --card-border: #d8dde0;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--nhs-grey-5);
            margin: 0;
            padding-bottom: 110px; /* Extra space for Nav */
            color: #231f20;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* HEADER */
        .header {
            background-color: var(--nhs-blue);
            color: var(--white);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 9999; /* Ensure header is always on top */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; }
        .nhs-logo { font-weight: 800; font-style: italic; border: 2px solid white; padding: 0 4px; font-size: 1.2rem; }

        /* CONTAINER */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 16px; 
            position: relative;
            z-index: 1;
        }

        /* CARDS */
        .card {
            background: var(--white);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
        }

        h2 {
            margin-top: 0; color: var(--nhs-blue); font-size: 1.5rem;
            border-bottom: 1px solid var(--card-border); padding-bottom: 12px; margin-bottom: 20px;
        }

        /* STATS COUNTER */
        .stat-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #eee;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: bold; color: var(--nhs-blue); flex: 1; }
        .stat-controls { display: flex; align-items: center; gap: 15px; }
        
        /* TOUCH TARGETS FIXED */
        button { touch-action: manipulation; }
        
        .stat-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            font-size: 1.5rem; color: white; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            -webkit-appearance: none; /* iOS Fix */
        }
        .btn-minus { background-color: var(--nhs-red); }
        .btn-plus { background-color: var(--nhs-green); }
        .stat-value { font-size: 1.25rem; font-weight: bold; width: 40px; text-align: center; }

        /* FORMS */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--nhs-grey-1); }
        input, select {
            width: 100%; padding: 12px; font-size: 16px;
            border: 2px solid var(--nhs-grey-1); border-radius: 4px;
            box-sizing: border-box; margin-bottom: 16px; background-color: var(--white);
            -webkit-appearance: none; /* iOS Fix */
        }
        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 1.5em; 
        }

        .btn {
            background-color: var(--nhs-green); color: var(--white); border: none;
            padding: 14px 24px; font-size: 1rem; font-weight: 600; border-radius: 4px;
            cursor: pointer; width: 100%; text-align: center; box-shadow: 0 4px 0 #006627;
            -webkit-appearance: none;
        }
        .btn:active { box-shadow: none; transform: translateY(4px); }

        .result-box {
            margin-top: 16px; padding: 16px; background-color: #e6f3fa;
            border-left: 8px solid var(--nhs-blue); display: none;
        }
        .result-value { font-size: 1.25rem; font-weight: bold; color: var(--nhs-dark-blue); }

        /* NAV BAR */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--white); border-top: 1px solid var(--card-border); 
            display: flex; justify-content: space-around; padding: 10px 0; 
            z-index: 9999; /* Highest priority */
            padding-bottom: env(safe-area-inset-bottom); /* iPhone X fix */
        }
        .nav-item { 
            text-align: center; font-size: 0.7rem; color: var(--nhs-blue); 
            cursor: pointer; flex: 1; display: flex; flex-direction: column; 
            align-items: center; gap: 4px; 
        }
        .nav-icon { font-size: 1.2rem; display: block; }
        .nav-item.active { font-weight: bold; border-bottom: 3px solid var(--nhs-blue); margin-bottom: -10px; padding-bottom: 7px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #reset-btn {
            background-color: var(--nhs-red); color: white; padding: 10px;
            text-align: center; margin-top: 20px; cursor: pointer; border-radius: 4px;
            font-weight: bold; font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Midwife Companion</h1>
        <div class="nhs-logo">NHS</div>
    </header>
    
    <div class="container">

        <div id="tab-mora" class="tab-content active">
            <div class="card">
                <h2>MORA Progress</h2>
                <div style="font-size:0.9rem; color:#666; margin-bottom:20px;">Stats save automatically.</div>
                
                <div class="stat-row">
                    <div class="stat-label">Births (40)</div>
                    <div class="stat-controls">
                        <button type="button" class="stat-btn btn-minus" onclick="updateStat('births', -1)">-</button>
                        <div class="stat-value" id="val-births">0</div>
                        <button type="button" class="stat-btn btn-plus" onclick="updateStat('births', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Antenatal (100)</div>
                    <div class="stat-controls">
                        <button type="button" class="stat-btn btn-minus" onclick="updateStat('ante', -1)">-</button>
                        <div class="stat-value" id="val-ante">0</div>
                        <button type="button" class="stat-btn btn-plus" onclick="updateStat('ante', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Postnatal (100)</div>
                    <div class="stat-controls">
                        <button type="button" class="stat-btn btn-minus" onclick="updateStat('post', -1)">-</button>
                        <div class="stat-value" id="val-post">0</div>
                        <button type="button" class="stat-btn btn-plus" onclick="updateStat('post', 1)">+</button>
                    </div>
                </div>
                
                <div class="stat-row">
                    <div class="stat-label">NIPE</div>
                    <div class="stat-controls">
                        <button type="button" class="stat-btn btn-minus" onclick="updateStat('nipe', -1)">-</button>
                        <div class="stat-value" id="val-nipe">0</div>
                        <button type="button" class="stat-btn btn-plus" onclick="updateStat('nipe', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Suturing</div>
                    <div class="stat-controls">
                        <button type="button" class="stat-btn btn-minus" onclick="updateStat('suture', -1)">-</button>
                        <div class="stat-value" id="val-suture">0</div>
                        <button type="button" class="stat-btn btn-plus" onclick="updateStat('suture', 1)">+</button>
                    </div>
                </div>

                <div id="reset-btn" onclick="forceReset()">‚ö†Ô∏è Fix App / Reset</div>
            </div>
        </div>

        <div id="tab-edd" class="tab-content">
            <div class="card">
                <h2>EDD Calculator</h2>
                <label for="lmp">First day of LMP</label>
                <input type="date" id="lmp">
                <label for="cycle">Cycle Length (Days)</label>
                <input type="number" id="cycle" value="28">
                <button class="btn" type="button" onclick="calculateEDD()">Calculate Date</button>
                <div id="edd-result" class="result-box">
                    <div>Estimated Due Date:</div>
                    <div class="result-value" id="edd-date-display">--/--/----</div>
                    <div>Gestational Age: <span id="gestation-display">0 weeks</span></div>
                </div>
            </div>
        </div>

        <div id="tab-bishop" class="tab-content">
            <div class="card">
                <h2>Bishop Score</h2>
                <label>Dilation</label>
                <select id="bish-dilation">
                    <option value="0">Closed (0)</option>
                    <option value="1">1-2 cm (1)</option>
                    <option value="2">3-4 cm (2)</option>
                    <option value="3">5+ cm (3)</option>
                </select>
                <label>Effacement</label>
                <select id="bish-efface">
                    <option value="0">0-30% (0)</option>
                    <option value="1">40-50% (1)</option>
                    <option value="2">60-70% (2)</option>
                    <option value="3">80%+ (3)</option>
                </select>
                <label>Station</label>
                <select id="bish-station">
                    <option value="0">-3 (0)</option>
                    <option value="1">-2 (1)</option>
                    <option value="2">-1 / 0 (2)</option>
                    <option value="3">+1 / +2 (3)</option>
                </select>
                <label>Consistency</label>
                <select id="bish-consist">
                    <option value="0">Firm (0)</option>
                    <option value="1">Medium (1)</option>
                    <option value="2">Soft (2)</option>
                </select>
                <label>Position</label>
                <select id="bish-pos">
                    <option value="0">Posterior (0)</option>
                    <option value="1">Mid (1)</option>
                    <option value="2">Anterior (2)</option>
                </select>
                <button class="btn" type="button" onclick="calculateBishop()">Calculate Score</button>
                <div id="bishop-result" class="result-box">
                    <div>Total Score: <span class="result-value" id="bishop-score-display">0</span></div>
                    <div id="bishop-interp" style="font-style:italic;"></div>
                </div>
            </div>
        </div>

        <div id="tab-meds" class="tab-content">
            <div class="card">
                <h2>Medication Index</h2>
                <input type="text" id="med-search" onkeyup="filterMeds()" placeholder="Search...">
                <div id="med-list">
                    <div class="med-item"><div class="med-name">Paracetamol</div><div class="med-dose">1g PO/IV q4-6h</div></div>
                    <div class="med-item"><div class="med-name">Dihydrocodeine</div><div class="med-dose">30mg PO q4-6h</div></div>
                    <div class="med-item"><div class="med-name">Pethidine</div><div class="med-dose">50-100mg IM</div></div>
                    <div class="med-item"><div class="med-name">Syntometrine</div><div class="med-dose">1ml IM</div></div>
                    <div class="med-item"><div class="med-name">Syntocinon</div><div class="med-dose">10 IU IM / 5 IU IV</div></div>
                    <div class="med-item"><div class="med-name">Ergometrine</div><div class="med-dose">500mcg IM</div></div>
                    <div class="med-item"><div class="med-name">Labetalol</div><div class="med-dose">200mg PO</div></div>
                    <div class="med-item"><div class="med-name">Mag Sulphate</div><div class="med-dose">4g IV Load</div></div>
                    <div class="med-item"><div class="med-name">Anti-D Ig</div><div class="med-dose">1500 IU / 500 IU</div></div>
                </div>
            </div>
        </div>

    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('mora', this)"><span class="nav-icon">üìä</span>MORA</div>
        <div class="nav-item" onclick="switchTab('edd', this)"><span class="nav-icon">üìÖ</span>EDD</div>
        <div class="nav-item" onclick="switchTab('bishop', this)"><span class="nav-icon">üìù</span>Bishop</div>
        <div class="nav-item" onclick="switchTab('meds', this)"><span class="nav-icon">üíä</span>Meds</div>
    </nav>

    <script>
        // === GLOBAL FUNCTIONS (Must be here to work) ===

        // 1. NAV LOGIC
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(element) element.classList.add('active');
        }

        // 2. MORA STATS LOGIC
        function loadStats() {
            const stats = ['births', 'ante', 'post', 'nipe', 'suture'];
            stats.forEach(key => {
                const val = localStorage.getItem('mora_' + key) || 0;
                const el = document.getElementById('val-' + key);
                if(el) el.innerText = val;
            });
        }

        function updateStat(key, change) {
            const el = document.getElementById('val-' + key);
            let val = parseInt(el.innerText) || 0;
            val += change;
            if(val < 0) val = 0;
            el.innerText = val;
            localStorage.setItem('mora_' + key, val);
        }

        // 3. FORCE RESET (The Fixer)
        function forceReset() {
            if(confirm("This will reset the app and fix freezing issues. Continue?")) {
                // Unregister Workers
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        for(let registration of registrations) { registration.unregister(); }
                    });
                }
                // Clear Cache
                caches.keys().then(names => {
                    for (let name of names) caches.delete(name);
                });
                // Reload
                setTimeout(() => window.location.reload(true), 1000);
            }
        }

        // 4. CALCULATORS
        function calculateEDD() {
            const lmpVal = document.getElementById('lmp').value;
            if(!lmpVal) { alert("Enter LMP date"); return; }
            const lmp = new Date(lmpVal);
            const cycle = parseInt(document.getElementById('cycle').value) || 28;
            const edd = new Date(lmp);
            edd.setDate(edd.getDate() + 280 + (cycle - 28));
            
            const diff = Math.floor((new Date() - lmp) / (1000*60*60*24));
            const w = Math.floor(diff/7);
            const d = diff%7;

            document.getElementById('edd-date-display').innerText = edd.toLocaleDateString();
            document.getElementById('gestation-display').innerText = w + " w " + d + " d";
            document.getElementById('edd-result').style.display = 'block';
        }

        function calculateBishop() {
            const ids = ['bish-dilation', 'bish-efface', 'bish-station', 'bish-consist', 'bish-pos'];
            let score = 0;
            ids.forEach(id => score += parseInt(document.getElementById(id).value));
            document.getElementById('bishop-score-display').innerText = score;
            document.getElementById('bishop-interp').innerText = score > 5 ? "Favourable" : "Unfavourable";
            document.getElementById('bishop-result').style.display = 'block';
        }

        function filterMeds() {
            const term = document.getElementById('med-search').value.toUpperCase();
            const items = document.querySelectorAll('.med-item');
            items.forEach(item => {
                const txt = item.innerText.toUpperCase();
                item.style.display = txt.includes(term) ? "" : "none";
            });
        }

        // 5. INITIALIZE
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            // Register SW with strict update checking
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    reg.update(); // Force check for update
                });
            }
        });

        // Error Catcher
        window.onerror = function(msg, url, line) {
            alert("App Error: " + msg + "\nLine: " + line + "\nTry the Reset button.");
        };
    </script>
</body>
</html>
