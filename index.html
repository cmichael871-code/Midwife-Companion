<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#005EB8">
    <title>Midwife Companion</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* === NHS STYLE THEME === */
        :root {
            --nhs-blue: #005EB8;
            --nhs-dark-blue: #003087;
            --nhs-green: #009639;
            --nhs-warm-yellow: #FFB81C;
            --nhs-red: #D5281B;
            --nhs-grey-1: #4C6272;
            --nhs-grey-5: #F0F4F5;
            --card-border: #d8dde0;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--nhs-grey-5);
            margin: 0;
            padding-bottom: 100px;
            color: #231f20;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        .header {
            background-color: var(--nhs-blue);
            color: var(--white);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 1000; /* Increased Z-Index to stay on top */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; }
        .nhs-logo { font-weight: 800; font-style: italic; border: 2px solid white; padding: 0 4px; font-size: 1.2rem; }

        /* CONTAINER */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 16px; 
            position: relative; 
            z-index: 1; /* Ensures content is clickable */
        }

        /* CARDS */
        .card {
            background: var(--white);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
        }

        h2 {
            margin-top: 0; color: var(--nhs-blue); font-size: 1.5rem;
            border-bottom: 1px solid var(--card-border); padding-bottom: 12px; margin-bottom: 20px;
        }

        /* STATS COUNTER */
        .stat-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #eee;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: bold; color: var(--nhs-blue); flex: 1; }
        .stat-controls { display: flex; align-items: center; gap: 15px; }
        .stat-btn {
            width: 44px; height: 44px; border-radius: 50%; border: none; /* Bigger touch target */
            font-size: 1.5rem; color: white; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
            touch-action: manipulation; /* Improves touch response */
        }
        .btn-minus { background-color: var(--nhs-red); }
        .btn-plus { background-color: var(--nhs-green); }
        .stat-value { font-size: 1.25rem; font-weight: bold; width: 40px; text-align: center; }

        /* INPUTS & BUTTONS */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--nhs-grey-1); }
        input, select {
            width: 100%; padding: 12px; font-size: 16px; /* Larger padding for touch */
            border: 2px solid var(--nhs-grey-1); border-radius: 4px;
            box-sizing: border-box; margin-bottom: 16px; background-color: var(--white);
        }
        input:focus, select:focus { outline: 3px solid var(--nhs-warm-yellow); border-color: var(--nhs-blue); }

        .btn {
            background-color: var(--nhs-green); color: var(--white); border: none;
            padding: 14px 24px; font-size: 1rem; font-weight: 600; border-radius: 4px;
            cursor: pointer; width: 100%; text-align: center; box-shadow: 0 4px 0 #006627;
        }
        .btn:active { box-shadow: none; transform: translateY(4px); }

        /* RESULTS */
        .result-box {
            margin-top: 16px; padding: 16px; background-color: #e6f3fa;
            border-left: 8px solid var(--nhs-blue); display: none;
        }
        .result-value { font-size: 1.25rem; font-weight: bold; color: var(--nhs-dark-blue); }

        /* MEDICATION LIST */
        .med-warning {
            background-color: #fff5f5; border: 1px solid #fcbwbw; color: #cc0000;
            padding: 10px; font-size: 0.85rem; border-radius: 4px; margin-bottom: 15px; font-weight: bold;
        }
        .med-item { padding: 16px 0; border-bottom: 1px solid #eee; }
        .med-name { color: var(--nhs-blue); font-weight: bold; font-size: 1.15rem; }
        .med-dose { font-weight: 600; color: #333; margin-top: 4px; font-size: 0.95rem; }
        .med-desc { color: #555; font-size: 0.9rem; margin-top: 4px; line-height: 1.4; }
        .med-tag { 
            display: inline-block; font-size: 0.75rem; padding: 3px 8px; 
            border-radius: 12px; margin-top: 8px; font-weight: 600; margin-right: 5px;
        }
        .tag-pain { background: #e8f5e9; color: #2e7d32; }
        .tag-emergency { background: #ffebee; color: #c62828; }
        .tag-labour { background: #e3f2fd; color: #1565c0; }
        .tag-gynae { background: #f3e5f5; color: #7b1fa2; }
        .tag-anti { background: #fff3e0; color: #ef6c00; }

        /* NAV BAR */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: var(--white); border-top: 1px solid var(--card-border); 
            display: flex; justify-content: space-around; padding: 12px 0; 
            z-index: 1000; /* High Z-index ensures it's always clickable */
        }
        .nav-item { 
            text-align: center; font-size: 0.7rem; color: var(--nhs-blue); 
            cursor: pointer; flex: 1; display: flex; flex-direction: column; 
            align-items: center; gap: 4px; 
            touch-action: manipulation;
        }
        .nav-icon { font-size: 1.2rem; display: block; }
        .nav-item.active { font-weight: bold; border-bottom: 3px solid var(--nhs-blue); margin-bottom: -12px; padding-bottom: 9px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #offline-status {
            background: var(--nhs-warm-yellow); color: #000; text-align: center;
            padding: 5px; font-size: 0.8rem; font-weight: bold; display: none;
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Midwife Companion</h1>
        <div class="nhs-logo">NHS</div>
    </header>
    
    <div id="offline-status">You are currently offline.</div>

    <div class="container">

        <div id="tab-mora" class="tab-content active">
            <div class="card">
                <h2>MORA Progress</h2>
                <div style="font-size:0.9rem; color:#666; margin-bottom:20px;">Tally counts are saved automatically.</div>
                
                <div class="stat-row">
                    <div class="stat-label">Births (40)</div>
                    <div class="stat-controls">
                        <button class="stat-btn btn-minus" onclick="updateStat('births', -1)">-</button>
                        <div class="stat-value" id="val-births">0</div>
                        <button class="stat-btn btn-plus" onclick="updateStat('births', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Antenatal Exams (100)</div>
                    <div class="stat-controls">
                        <button class="stat-btn btn-minus" onclick="updateStat('ante', -1)">-</button>
                        <div class="stat-value" id="val-ante">0</div>
                        <button class="stat-btn btn-plus" onclick="updateStat('ante', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Postnatal Exams (100)</div>
                    <div class="stat-controls">
                        <button class="stat-btn btn-minus" onclick="updateStat('post', -1)">-</button>
                        <div class="stat-value" id="val-post">0</div>
                        <button class="stat-btn btn-plus" onclick="updateStat('post', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Complex Care</div>
                    <div class="stat-controls">
                        <button class="stat-btn btn-minus" onclick="updateStat('complex', -1)">-</button>
                        <div class="stat-value" id="val-complex">0</div>
                        <button class="stat-btn btn-plus" onclick="updateStat('complex', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">NIPE</div>
                    <div class="stat-controls">
                        <button class="stat-btn btn-minus" onclick="updateStat('nipe', -1)">-</button>
                        <div class="stat-value" id="val-nipe">0</div>
                        <button class="stat-btn btn-plus" onclick="updateStat('nipe', 1)">+</button>
                    </div>
                </div>

                <div class="stat-row">
                    <div class="stat-label">Suturing</div>
                    <div class="stat-controls">
                        <button class="stat-btn btn-minus" onclick="updateStat('suture', -1)">-</button>
                        <div class="stat-value" id="val-suture">0</div>
                        <button class="stat-btn btn-plus" onclick="updateStat('suture', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-edd" class="tab-content">
            <div class="card">
                <h2>EDD Calculator</h2>
                <label for="lmp">First day of LMP</label>
                <input type="date" id="lmp">
                <label for="cycle">Cycle Length (Days)</label>
                <input type="number" id="cycle" value="28" placeholder="28">
                <button class="btn" onclick="calculateEDD()">Calculate Date</button>
                <div id="edd-result" class="result-box">
                    <div>Estimated Due Date:</div>
                    <div class="result-value" id="edd-date-display">--/--/----</div>
                    <div style="font-size: 0.9rem; margin-top:5px;">Gestational Age: <span id="gestation-display">0 weeks</span></div>
                </div>
            </div>
        </div>

        <div id="tab-bishop" class="tab-content">
            <div class="card">
                <h2>Bishop Score</h2>
                <label>Dilation (cm)</label>
                <select id="bish-dilation">
                    <option value="0">Closed (0)</option>
                    <option value="1">1-2 cm (1)</option>
                    <option value="2">3-4 cm (2)</option>
                    <option value="3">5+ cm (3)</option>
                </select>
                <label>Effacement</label>
                <select id="bish-efface">
                    <option value="0">0-30% (0)</option>
                    <option value="1">40-50% (1)</option>
                    <option value="2">60-70% (2)</option>
                    <option value="3">80%+ (3)</option>
                </select>
                <label>Station</label>
                <select id="bish-station">
                    <option value="0">-3 (0)</option>
                    <option value="1">-2 (1)</option>
                    <option value="2">-1 / 0 (2)</option>
                    <option value="3">+1 / +2 (3)</option>
                </select>
                <label>Cervical Consistency</label>
                <select id="bish-consist">
                    <option value="0">Firm (0)</option>
                    <option value="1">Medium (1)</option>
                    <option value="2">Soft (2)</option>
                </select>
                <label>Cervical Position</label>
                <select id="bish-pos">
                    <option value="0">Posterior (0)</option>
                    <option value="1">Mid-position (1)</option>
                    <option value="2">Anterior (2)</option>
                </select>
                <button class="btn" onclick="calculateBishop()">Calculate Score</button>
                <div id="bishop-result" class="result-box">
                    <div>Total Score:</div>
                    <div class="result-value" id="bishop-score-display">0</div>
                    <div id="bishop-interp" style="margin-top: 5px; font-style: italic;"></div>
                </div>
            </div>
        </div>

        <div id="tab-meds" class="tab-content">
            <div class="card">
                <h2>Medication Index</h2>
                <div class="med-warning">‚ö†Ô∏è ALWAYS check your local Trust Guidelines (PGDs) & BNF before administration.</div>
                <input type="text" id="med-search" onkeyup="filterMeds()" placeholder="Search (e.g. 'PPH', 'Anti-D')...">
                <div id="med-list">
                    <div class="med-item"><div class="med-name">Paracetamol</div><div class="med-dose">Dose: 1g PO/IV q4-6h (Max 4g/24h)</div><div class="med-desc">Mild pain/pyrexia. Caution &lt;50kg.</div><span class="med-tag tag-pain">Analgesia</span></div>
                    <div class="med-item"><div class="med-name">Dihydrocodeine</div><div class="med-dose">Dose: 30mg PO q4-6h</div><div class="med-desc">Moderate pain (postnatal). Avoid in BF if baby prem.</div><span class="med-tag tag-pain">Analgesia</span></div>
                    <div class="med-item"><div class="med-name">Pethidine</div><div class="med-dose">Dose: 50-100mg IM</div><div class="med-desc">1st stage labour. Crosses placenta (resp dep).</div><span class="med-tag tag-pain">Analgesia</span></div>
                    <div class="med-item"><div class="med-name">Entonox</div><div class="med-dose">Dose: Inhaled 50:50</div><div class="med-desc">Self-administered. Rapid onset/offset.</div><span class="med-tag tag-pain">Analgesia</span></div>
                    <div class="med-item"><div class="med-name">Syntocinon (Oxytocin)</div><div class="med-dose">Dose: 10 IU IM or 5 IU IV</div><div class="med-desc">3rd stage / PPH prevention.</div><span class="med-tag tag-labour">3rd Stage</span></div>
                    <div class="med-item"><div class="med-name">Syntometrine</div><div class="med-dose">Dose: 1ml IM</div><div class="med-desc">3rd Stage. C/I: Hypertension.</div><span class="med-tag tag-labour">3rd Stage</span></div>
                    <div class="med-item"><div class="med-name">Ergometrine</div><div class="med-dose">Dose: 500mcg IM / 250mcg IV</div><div class="med-desc">PPH. Sustained contraction. C/I: Hypertension.</div><span class="med-tag tag-emergency">PPH</span></div>
                    <div class="med-item"><div class="med-name">Carboprost</div><div class="med-dose">Dose: 250mcg Deep IM</div><div class="med-desc">Severe PPH. C/I: Asthma.</div><span class="med-tag tag-emergency">PPH</span></div>
                    <div class="med-item"><div class="med-name">Misoprostol</div><div class="med-dose">Dose: 800mcg PR/SL (PPH)</div><div class="med-desc">Prostaglandin. PPH or IOL.</div><span class="med-tag tag-emergency">PPH</span></div>
                    <div class="med-item"><div class="med-name">Labetalol</div><div class="med-dose">Dose: 200mg PO</div><div class="med-desc">Hypertension/Pre-E. C/I: Asthma.</div><span class="med-tag tag-gynae">Hypertension</span></div>
                    <div class="med-item"><div class="med-name">Magnesium Sulphate</div><div class="med-dose">Dose: 4g IV Load</div><div class="med-desc">Eclampsia prevention / Neuroprotection.</div><span class="med-tag tag-emergency">Emergency</span></div>
                    <div class="med-item"><div class="med-name">Adrenaline</div><div class="med-dose">Dose: 500mcg (1:1000) IM</div><div class="med-desc">Anaphylaxis. Repeat 5 min.</div><span class="med-tag tag-emergency">Emergency</span></div>
                    <div class="med-item"><div class="med-name">Benzylpenicillin</div><div class="med-dose">Dose: 3g IV Load</div><div class="med-desc">GBS Prophylaxis intrapartum.</div><span class="med-tag tag-anti">Antibiotic</span></div>
                    <div class="med-item"><div class="med-name">Anti-D Ig</div><div class="med-dose">Dose: 1500 IU / 500 IU</div><div class="med-desc">RhD Neg prophylaxis.</div><span class="med-tag tag-gynae">Antenatal</span></div>
                    <div class="med-item"><div class="med-name">Vitamin K</div><div class="med-dose">Dose: 1mg IM</div><div class="med-desc">VKDB prevention.</div><span class="med-tag tag-labour">Neonatal</span></div>
                </div>
            </div>
        </div>

    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('mora', this)"><span class="nav-icon">üìä</span>MORA</div>
        <div class="nav-item" onclick="switchTab('edd', this)"><span class="nav-icon">üìÖ</span>EDD</div>
        <div class="nav-item" onclick="switchTab('bishop', this)"><span class="nav-icon">üìù</span>Bishop</div>
        <div class="nav-item" onclick="switchTab('meds', this)"><span class="nav-icon">üíä</span>Meds</div>
    </nav>

    <script>
        // === SAFE MODE JAVASCRIPT ===

        // 1. NAVIGATION
        function switchTab(tabName, element) {
            try {
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                const target = document.getElementById('tab-' + tabName);
                if (target) target.classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if (element) element.classList.add('active');
            } catch (e) { console.error("Nav error", e); }
        }

        // 2. MORA STATS (With Error Handling)
        const stats = ['births', 'ante', 'post', 'complex', 'nipe', 'suture'];

        function loadStats() {
            try {
                stats.forEach(key => {
                    const val = localStorage.getItem('mora_' + key) || 0;
                    const el = document.getElementById('val-' + key);
                    if (el) el.innerText = val;
                });
            } catch (e) { console.error("Storage load error", e); }
        }

        function updateStat(key, change) {
            try {
                const currentEl = document.getElementById('val-' + key);
                if (!currentEl) return;
                
                let currentVal = parseInt(currentEl.innerText) || 0;
                let newVal = currentVal + change;
                if (newVal < 0) newVal = 0;
                
                currentEl.innerText = newVal;
                localStorage.setItem('mora_' + key, newVal);
            } catch (e) { console.error("Storage save error", e); }
        }

        // 3. MED FILTER
        function filterMeds() {
            try {
                const input = document.getElementById('med-search');
                const filter = input.value.toUpperCase();
                const items = document.getElementsByClassName('med-item');
                for (let i = 0; i < items.length; i++) {
                    const txt = items[i].textContent || items[i].innerText;
              
